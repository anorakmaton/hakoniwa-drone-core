[English](README.md) ｜ 日本語

# これは何？

このドキュメントは、箱庭ドローンシミュレータにおける環境シミュレーション機能（例：風の影響）について説明します。リアルな外乱要因を適用し、ドローンの飛行挙動に反映させることが目的です。

# 箱庭の環境の考え方

箱庭では、特定の技術に依存せず、再利用可能な機能を提供することを目指しています。
そのため、環境データは`json`のようなプログラムで扱いやすいフォーマットで管理し、様々なプログラミング言語から柔軟に利用できる形にしたいと考えています。

ドローンのシミュレーションにおける環境要因を考慮する際、静的情報と動的情報を分けて管理することが効率的です。
例えば、位置情報は静的なものであり、データベース化しやすい要素です。
一方、天候情報（風、温度、湿度、雨など）は動的な要素であり、時間や場所に応じて変化します。

そこで、箱庭では、以下のように環境情報を管理することにしました。

- **空間情報**  
  空間情報として、任意の領域に一意のID（エリアID）を割り当てます。このエリアIDを用いることで、空間ごとの情報を簡単に参照できます。
  
- **空間プロパティ情報**  
  空間ごとのプロパティ情報として、風や温度、湿度などの静的・動的データがあります。これらはエリアIDとリンクし、特定の空間に関連付けられます。

箱庭では、これらの設計を基に、より柔軟かつ再利用可能な環境シミュレーションを提供します。

# アーキテクチャ

![image](./images/architecture.png)


このアーキテクチャ図は、箱庭ドローンシミュレータにおける環境シミュレーションの全体的な流れを示しています。

1. **環境情報の処理**  
   環境（箱庭アセット）では、箱庭PDUデータを監視し、ドローンの位置情報から対応するエリアIDを空間情報から取得します。そして、そのエリアIDのプロパティ情報（風、温度、湿度など）を読み取ることで、対象のドローンの外乱情報としてイベントを発生させます。

2. **外乱の適用とシミュレーション**  
   箱庭ドローンシミュレータは、環境から受け取った外乱（例：風の影響）を使用して、ドローンのセンサーや物理挙動をシミュレーションします。この際、実際のドローンの操作や動作に近い挙動がシミュレートされます。

3. **ドローンの位置情報の取得と伝達**  
   外乱によるシミュレーション結果は、ドローンの位置・姿勢情報として箱庭PDUデータに書き込みされます。そして、このデータは、ゲームエンジン（UnityまたはUnreal Engine）側でビジュアライズする仕組みになっていますので、外乱イベントが自動的にビジュアライズされます。

# 空間情報のデータ構造定義

- **座標系**は、ROS座標系とします。
- **空間定義**は`area.json`にて管理し、AABBで範囲を定義します。
- **プロパティ定義**は`area_property.json`に分けて、空間ごとに風や温度といった属性を`area_id`で関連付けます。
- **境界定義**は`boundary.json`にて管理し、地面や天井などの物理的な境界を定義します。

1. **`area.json`**:
   - 各空間の定義を行います。`area_id`で各空間に一意の識別子を与え、`bounds`でAABB（最小点、最大点）による空間の範囲を定義します。

2. **`area_property.json`**:
   - 空間に対するプロパティ（例：風、温度、海面気圧）を定義します。各プロパティは`area_id`によって`area.json`の空間にリンクします。これにより、空間ごとに異なるプロパティを簡単に設定できます。

3. **`boundary.json`**:
    - シミュレーション空間内の物理的な境界（地面、天井など）を定義します。これにより、ドローンが指定された範囲外に出ることを防ぎます。

## 1. 空間定義（`area.json`）

```json
{
  "space_areas": [
    {
      "area_id": "area_1",
      "bounds": {
        "min": { "x": -2.0, "y": -2.0, "z": 0 },
        "max": { "x": 2.0,  "y": 2.0,  "z": 20 }
      }
    },
    {
      "area_id": "area_2",
      "bounds": {
        "min": { "x": 2.0, "y": -2.0, "z": 0 },
        "max": { "x": 6.0, "y":  2.0, "z": 20 }
      }
    }
  ]
}
```

- `space_areas`: 空間エリアのリスト
  - `area_id`: (string) エリアを識別するためのユニークなID
  - `bounds`: (object) AABB（軸並行境界ボックス）で定義される空間の範囲
    - `min`: (object) AABBの最小座標点 (m)
      - `x`, `y`, `z`: (float)
    - `max`: (object) AABBの最大座標点 (m)
      - `x`, `y`, `z`: (float)

## 2. プロパティ定義（`area_property.json`）


```json
{
    "area_properties": [
      {
        "area_id": "area_1",
        "properties": {
          "wind_velocity": [0.0, 0.0, 0.0],
          "temperature": 10.5,
          "sea_level_atm": 0.9
        }
      },
      {
        "area_id": "area_2",
        "properties": {
          "wind_velocity": [0.0, -1.0, 0.0],
          "temperature": -15.0,
          "sea_level_atm": 1.1
        }
      }
    ]
  }
```

- `area_properties`: エリアプロパティのリスト
  - `area_id`: (string) `area.json` の `area_id` と対応
  - `properties`: (object) エリアの物理的プロパティ
    - `wind_velocity`: (array of float) 風速ベクトル [x, y, z] (m/s)
    - `temperature`: (float) 気温 (℃)
    - `sea_level_atm`: (float) 海面気圧 (atm)

## 3. 境界定義（`boundary.json`）

```json
[
    {
        "name": "ground",
        "position": [0.0, 0.0, 0.0],
        "size": [10.0, 10.0],
        "rotation": [0.0, 0.0, 0.0]
    },
    {
        "name": "ceiling",
        "position": [0.0, 0.0, 2.0],
        "size": [1.0, 1.0],
        "rotation": [0.0, 0.0, 0.0]
    }
]
```

- `name`: (string) 境界の名前
- `position`: (array of float) 境界（矩形）の中心座標 [x, y, z] (m)
- `size`: (array of float) 境界（矩形）のサイズ [幅, 高さ] (m)
- `rotation`: (array of float) 境界（矩形）のオイラー角 [X, Y, Z] (deg)

# 空間情報を扱うためのクラス設計

![image](images/class-diagram.png)


このクラス設計は、箱庭の空間情報定義を柔軟に拡張可能な構造にすることを意図しています。
特に、本物の空間情報定義や異なる環境設定を組み込めるように設計されています。
そのため、具体的な実装は箱庭仕様をベースとしつつ、将来的に差し替えが可能な構造を目指しています。

1. **`HakoEnvEvent`**  
   - 環境イベントのメインクラスであり、環境要因（風、温度など）を管理します。
   - ドローンやその他のシミュレーション要素に環境情報を適用する役割を担います。

2. **`IHakoAreaPropAccessor`** と **`IHakoAreaAccessor`**（抽象クラス）  
   - `area_property.json` や `area.json` のデータを抽象的に扱うためのインターフェースです。
   - 空間情報やプロパティ情報の取得を統一的な方法でアクセスできるように設計されています。
   - この抽象クラスにより、異なる空間情報ソースやプロパティソースを将来的に差し替えできる拡張性を提供します。

3. **`HakoAreaPropAccessorImpl` と `HakoAreaAccessorImpl`**  
   - 具体的な実装クラスであり、箱庭の仕様に基づいて空間情報やプロパティ情報を取得します。
   - `area.json` や `area_property.json` ファイルからデータを取得し、それをシミュレーションに反映します。

4. **`HakoAABBObjectSpace`**  
   - 軸平行バウンディングボックス（AABB）を使って空間領域を定義するクラスです。これにより、各空間の領域が効率的に定義・管理されます。

5. **`HakoBoundary`**
   - `boundary.json`で定義された境界（地面など）とドローンとの距離を計算し、プロペラ風（地面効果など）のシミュレーションに利用するためのクラスです。

この設計では、`area_id`によって空間情報とプロパティ情報をリンクさせるため、異なる空間領域ごとに異なるプロパティ（風速や温度など）を容易に適用できます。また、抽象クラスを使うことで、今後の拡張や他の仕様への対応も可能にしています。


# サンプル実装

サンプル実装はこちらで公開しています: [Hakoniwa Drone's Environment Assets](https://github.com/toppers/hakoniwa-px4sim/tree/main/drone_api/assets)

- **`hako_env_event.py`**: 箱庭アセットであるHakoEnvEventの実装が含まれています。これは環境イベントをシミュレートするための主要なモジュールです。
- **`lib`**: クラス設計に基づいてPythonで実装されたコードが格納されています。ここでは、空間情報やプロパティ情報のアクセスロジックが記述されています。
- **`config`**: サンプルの環境データが格納されています。`area.json`、`area_property.json`、`boundary.json`のようなデータファイルが含まれています。
- **`tests`**: テストコードが格納されており、実装の動作確認や挙動をテストするためのスクリプトが含まれています。

このサンプル実装に基づいて、必要に応じて環境を構築し、シミュレーションを試してみることができます。

# ユースケース例

この環境シミュレーション機能は、様々なシナリオでドローンの挙動をテストするために利用できます。

- **特定のエリアでの耐風性能テスト**
  - `area.json`で狭い空間を定義し、`area_property.json`でそのエリアにだけ強い横風を設定します。
  - ドローンがそのエリアを通過する際の姿勢維持性能や、制御アルゴリズムの堅牢性を評価できます。

- **地面効果（Ground Effect）のシミュレーション**
  - `boundary.json`で地面を定義し、ドローンが着陸する際の挙動を観察します。
  - 地面付近でプロペラ風が機体に与える影響（浮力が増すなど）をシミュレーションし、着陸制御の妥当性を確認できます。

- **複雑な気象環境の再現**
  - `area.json`で空間を細かく分割し、それぞれのエリアで風速や気圧を少しずつ変えることで、ビル風や複雑な地形が作り出す気流を模擬し、ドローンの安定性をテストします。

# 環境のカスタマイズ方法

利用者は、`config`内のJSONファイルを編集することで、独自のシミュレーション環境を自由に構築できます。

1. **設定ファイルの準備**
   - `drone_api/assets/config` ディレクトリを参考に、ご自身の環境設定用のディレクトリを作成します。

2. **空間区画の定義 (`area.json`)**
   - シミュレーション空間をどのように分割したいか考え、各エリアの範囲をAABBで定義します。
   - 例えば、ドローンが通過する特定の経路だけを別のエリアとして定義することができます。

3. **物理プロパティの設定 (`area_property.json`)**
   - `area.json`で定義した`area_id`ごとに、風速、気温、気圧などのパラメータを設定します。
   - 風を無効にしたい場合は、`wind_velocity`を `[0.0, 0.0, 0.0]` に設定します。

4. **シミュレーションの実行**
   - `hako_env_event.py` を実行する際に、引数として作成した設定ディレクトリのパスを指定します。
   - これにより、カスタマイズされた環境でシミュレーションが開始されます。

# サンプル実行方法

## 前提条件

- Python 3.12 がインストールされていること
- Unityエディタの準備ができており、hakoniwa-unity-drone/simulationプロジェクトを開いてていること
- `bash`が使用できる環境であること
- 現時点のサポートOS：MacOS, Ubuntu22.0.4, 24.04
- 本サンプルは、ラジコン操作で行います
- 本サンプルを実行するには、3個の端末を用意する必要があります

## 概要

本サンプルでは、ラジコンを使って箱庭ドローンシミュレーションを操作します。3つの端末を使い、以下の手順でシステムをセットアップします。
1. 端末A: シミュレーションを起動
2. 端末B: 環境イベントを管理
3. 端末C: ラジコン操作

## 端末A 

端末 A では、箱庭シミュレーションを起動します。


## 端末B

端末 B では、箱庭アセット HakoEnvEventを起動します。このアセットは、環境イベント（風や障害物など）をイベントを発生させます。


```
cd hakoniwa-drone-core/drone_api/
```

この際、PYTHONPATHを追加します。

```
export PYTHONPATH=${PYTHONPATH}:`pwd`
export PYTHONPATH=${PYTHONPATH}:`pwd`/assets
export PYTHONPATH=${PYTHONPATH}:`pwd`/assets/lib
```

```
cd assets
```

```
python3 hako_env_event.py <PDUコンフィグファイルパス> 20 config
```

## Unity環境

Unityアプリを実行します。


## 端末C

ラジコン操作アプリを起動します。

```
cd hakoniwa-drone-core/drone_api/
```

```
python rc/rc-custom.py <PDUコンフィグファイルパス> rc/rc_config/ps4-control.json 
```

